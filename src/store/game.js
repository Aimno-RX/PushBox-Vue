import { defineStore } from 'pinia';
import { reactive, ref, computed } from 'vue';

// 引用userGameStore
export const useGameStore = defineStore('game', () => {
  const levels = [
    // 关卡1:  6x5 - 简单教学
    {
      map: [
        ['#', '#', '#', '#', '#', '#'],
        ['#', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', 'P', 'B', 'G', '#'],
        ['#', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', ' ', ' ', ' ', '#'],
        ['#', '#', '#', '#', '#', '#']
      ]
    },
    // 关卡2: 6x5 - 简单
    {
      map: [
        ['#', '#', '#', '#', '#', '#'],
        ['#', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', 'P', 'B', ' ', '#'],
        ['#', ' ', ' ', 'B', 'G', '#'],
        ['#', ' ', ' ', 'G', ' ', '#'],
        ['#', '#', '#', '#', '#', '#']
      ]
    },
    // 关卡3: 6x5 - 容易
    {
      map: [
        ['#', '#', '#', '#', '#', '#', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', 'P', 'B', ' ', ' ', '#'],
        ['#', ' ', ' ', '#', 'B', 'G', '#'],
        ['#', ' ', ' ', ' ', ' ', 'G', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', '#', '#', '#', '#', '#', '#']
      ]
    },
    // 关卡4: 10x5 - 更多箱子
    {
      map: [
        ['#', '#', '#', '#', '#', '#', '#', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', 'P', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', 'B', ' ', 'B', ' ', ' ', '#'],
        ['#', ' ', ' ', '#', ' ', 'B', 'G', '#'],
        ['#', ' ', ' ', ' ', ' ', 'G', ' ', '#'],
        ['#', ' ', ' ', ' ', ' ', 'G', ' ', '#'],
        ['#', '#', '#', '#', '#', '#', '#', '#']
      ]
    },
    // 关卡5: 10x5 - 更多箱子和目标
    {
      map: [
        ['#', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', 'P', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', 'B', ' ', 'B', ' ', 'B', ' ', '#'],
        ['#', ' ', ' ', '#', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', ' ', ' ', ' ', '#', 'G', 'G', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', 'G', ' ', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', '#', '#', '#', '#', '#', '#', '#', '#']
      ]
    },
    // 关卡6: 10x6 - 更多箱子
    {
      map: [
        ['#', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', 'P', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', 'B', ' ', 'B', ' ', 'B', ' ', '#'],
        ['#', ' ', ' ', '#', '#', ' ', ' ', ' ', '#'],
        ['#', ' ', ' ', ' ', '#', ' ', 'G', 'G', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', 'G', ' ', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', '#', '#', '#', '#', '#', '#', '#', '#']
      ]
    },
    // 关卡7: 10x10 - 困难布局
    {
      map: [
        ['#', '#', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#'],
        ['#', ' ', 'P', ' ', ' ', '#', ' ', 'B', ' ', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', ' ', 'B', ' ', '#'],
        ['#', '#', '#', ' ', '#', '#', '#', ' ', ' ', '#'],
        ['#', 'G', ' ', ' ', ' ', ' ', ' ', ' ', '#', '#'],
        ['#', 'G', ' ', ' ', ' ', 'B', ' ', ' ', ' ', '#'],
        ['#', 'G', ' ', ' ', '#', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', '#'],
        ['#', '#', '#', '#', '#', '#', '#', '#', '#', '#']
      ]
    },
    // 关卡8: 10*10 - 迷宫式布局
    {
      map: [
        ['#', '#', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#', ' ', ' ', '#', ' ', ' ', ' ', 'G', ' ', '#'],
        ['#', ' ', '#', '#', ' ', ' ', '#', '#', ' ', '#'],
        ['#', ' ', '#', ' ', ' ', ' ', ' ', '#', ' ', '#'],
        ['#', ' ', '#', ' ', '#', '#', ' ', '#', ' ', '#'],
        ['#', ' ', ' ', 'B', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', '#', ' ', '#', '#', ' ', '#', '#', ' ', '#'],
        ['#', ' ', ' ', ' ', 'B', ' ', '#', ' ', 'G', '#'],
        ['#', 'P', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#'],
        ['#', '#', '#', '#', '#', '#', '#', '#', '#', '#']
      ]

    },
    // 关卡9: 20*9 - 高难度布局1
    {
      map: [
        ['#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#', 'G', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', 'G', '#'],
        ['#', ' ', '#', '#', '#', ' ', '#', ' ', '#', '#', '#', ' ', '#', ' ', '#', '#', '#', '#', ' ', '#'],
        ['#', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', '#', ' ', ' ', ' ', '#', 'B', 'B', '#', ' ', '#'],
        ['#', '#', '#', ' ', '#', '#', '#', '#', '#', 'B', '#', '#', '#', '#', '#', ' ', ' ', '#', ' ', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 'B', ' ', ' ', ' ', ' ', ' ', ' ', 'B', ' ', 'P', '#'],
        ['#', ' ', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', ' ', '#'],
        ['#', 'G', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 'G', '#'],
        ['#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#']
      ]
    },
    // 关卡10: 30*10 - 高难度布局2
    {
      map: [
        ['#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#', 'P', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', '#'],
        ['#', ' ', '#', ' ', '#', ' ', '#', ' ', '#', ' ', '#', ' ', '#', ' ', '#', ' ', '#', ' ', '#', ' ', '#', ' ', '#', ' ', '#', ' ', '#', '#', ' ', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', 'G', ' ', '#'],
        ['#', '#', '#', '#', '#', '#', '#', '#', '#', ' ', '#', '#', '#', '#', '#', '#', '#', ' ', '#', '#', '#', '#', '#', '#', '#', ' ', '#', 'G', ' ', '#'],
        ['#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', 'G', ' ', '#'],
        ['#', ' ', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', ' ', ' ', '#'],
        ['#', ' ', ' ', ' ', 'B', ' ', 'B', ' ', 'B', ' ', 'B', ' ', 'B', ' ', 'B', ' ', 'B', ' ', 'B', ' ', 'B', ' ', 'B', ' ', 'B', ' ', ' ', ' ', ' ', '#'],
        ['#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', ' ', '#'],
        ['#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#']
      ]
    }
  ];

  //用ref响应式,创建响应式的简单数据类型变量，用于跟踪当前关卡索引、移动步数和游戏状态
  const currentLevelIndex = ref(0);
  const moves = ref(0);
  const gameState = ref('playing'); // 'playing', 'won', 'failed'

  //用reactive响应式,创建深层响应式对象，map 存储游戏地图二维数组，player 跟踪玩家位置，goals 存储目标点位置
  const map = reactive([]);
  const player = reactive({ x: 0, y: 0 });
  const goals = reactive([]);
  const originalMap = ref([]); // 存储原始地图状态用于重置

  function loadLevel(index) {
    moves.value = 0;
    gameState.value = 'playing';
    const level = levels[index];
    map.length = 0;
    goals.length = 0;

    // 存储原始地图
    originalMap.value = JSON.parse(JSON.stringify(level.map));

    level.map.forEach(row => map.push([...row]));

    // 找到玩家初始位置和目标位置
    for (let i = 0; i < map.length; i++) {
      for (let j = 0; j < map[i].length; j++) {
        if (map[i][j] === 'P') {
          player.x = i;
          player.y = j;
        } else if (map[i][j] === 'G') {
          goals.push({ x: i, y: j });
        }
      }
    }
  }

  function resetLevel() {
    moves.value = 0;
    gameState.value = 'playing';
    map.length = 0;
    goals.length = 0;

    // 从原始地图重新加载
    originalMap.value.forEach(row => map.push([...row]));

    // 重新找到玩家位置和目标位置
    for (let i = 0; i < map.length; i++) {
      for (let j = 0; j < map[i].length; j++) {
        if (map[i][j] === 'P' || map[i][j] === 'Y') {
          player.x = i;
          player.y = j;
          // 如果重置时玩家在目标点上，恢复为目标点
          if (map[i][j] === 'Y') {
            map[i][j] = 'G';
          }
        } else if (map[i][j] === 'G') {
          goals.push({ x: i, y: j });
        }
      }
    }
  }

  function move(dx, dy) {
    if (gameState.value !== 'playing') return;

    const nx = player.x + dx;
    const ny = player.y + dy;

    // 检查边界和墙壁
    if (nx < 0 || nx >= map.length || ny < 0 || ny >= map[0].length || map[nx][ny] === '#') return;

    // 处理箱子移动
    if (map[nx][ny] === 'B' || map[nx][ny] === 'X') {
      const nnx = nx + dx;
      const nny = ny + dy;

      // 检查箱子是否可以移动
      if (nnx < 0 || nnx >= map.length || nny < 0 || nny >= map[0].length ||
        map[nnx][nny] === '#' || map[nnx][nny] === 'B' || map[nnx][nny] === 'X') {
        return;
      }

      // 保存原始目标点状态
      const isCurrentBoxOnGoal = map[nx][ny] === 'X';

      // 移动箱子
      if (map[nnx][nny] === 'G') {
        map[nnx][nny] = 'X'; // 箱子在目标点上
      } else {
        map[nnx][nny] = 'B'; // 普通箱子
      }

      // 恢复原来的格子
      if (isCurrentBoxOnGoal) {
        map[nx][ny] = 'G'; // 恢复为目标点
      } else {
        map[nx][ny] = ' '; // 恢复为空地
      }
    }

    // 移动玩家
    const wasPlayerOnGoal = map[player.x][player.y] === 'Y'; // 玩家在目标点上
    player.x = nx;
    player.y = ny;
    moves.value++;

    // 更新玩家位置显示
    if (map[player.x][player.y] === 'G') {
      map[player.x][player.y] = 'Y'; // 玩家在目标点上
    } else if (wasPlayerOnGoal) {
      // 如果玩家离开目标点，恢复目标点
      const prevX = player.x - dx;
      const prevY = player.y - dy;
      map[prevX][prevY] = 'G';
    }

    if (checkWin()) {
      gameState.value = 'won';
      // 使用 setTimeout 延迟弹窗，让玩家看到箱子移动完成
      setTimeout(() => {
        if (currentLevelIndex.value < levels.length - 1) {
          alert(`第 ${currentLevelIndex.value + 1} 关完成！进入下一关`);
          currentLevelIndex.value++;
          loadLevel(currentLevelIndex.value);
        } else {
          alert('恭喜你，所有关卡通关！');
        }
      }, 100);
    }
  }

  function checkWin() {
    // 检查所有目标位置是否都有箱子（包括箱子在目标点上）
    for (const goal of goals) {
      if (map[goal.x][goal.y] !== 'X') {
        return false;
      }
    }
    return true;
  }

  // 使用 computed实现侦听功能，自动计算当前关卡序号和总关卡数
  const levelNumber = computed(() => currentLevelIndex.value + 1);
  const totalLevels = computed(() => levels.length);

  // 初始加载第1关
  loadLevel(currentLevelIndex.value);

  return {
    map,
    player,
    moves,
    move,
    levelNumber,
    totalLevels,
    loadLevel,
    currentLevelIndex,
    resetLevel,
    gameState,
    goals  // 导出 goals 供 Game.vue 使用
  };
});